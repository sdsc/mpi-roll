<?xml version="1.0" standalone="no"?>

<kickstart>

<description>
MPI libraries
http://www.mcs.anl.gov/research/projects/mpi/mpich1-old
http://www.mcs.anl.gov/research/projects/mpich2
http://www.open-mpi.org
http://mvapich.cse.ohio-state.edu
</description>

<copyright>
Copyright (c) 2000 - 2011 The Regents of the University of California.
All rights reserved. Rocks(r) v5.1 www.rocksclusters.org
</copyright>

<changelog>
</changelog>

<package>ROLLMPI_ROLLCOMPILER_ROLLNETWORK</package>
<package>mpi-modules</package>
<package>mpi-roll-test</package>

<post>

# The openmpi build seems to have a bug in its libtool processing; it
# references $(INSTALL)/lib in its lib/*.la files instead of $(INSTALL)/lib64.
# This is a cheap/quick fix.
if test -d /opt/openmpi; then
  /usr/bin/perl -pi -e 's#/opt/torque/lib\b#/opt/torque/lib64#g' \
                       /opt/openmpi/ROLLCOMPILER/ROLLNETWORK/lib/*.la
fi

#
# Install the limic and knem kernel objects if they came w/the roll build.
# For some reason, copying to /lib/modules once (outside the post- files)
# doesn't work; copying every time is a brute-force hack.
#
<file name="/etc/rc.d/rocksconfig.d/post-97-limic" perms="0755">
#!/bin/sh
kos=`find /opt/mvapich2 -name limic.ko | head -1`
if test -n "$kos"; then
  /bin/cp $kos /lib/modules/`uname -r`/extra/
  /sbin/depmod -a
  /sbin/modprobe limic
  /bin/sleep 1
  /bin/chmod 644 /dev/limic
fi
</file> 

<file name="/etc/rc.d/rocksconfig.d/post-97-knem" perms="0755">
#!/bin/sh
kos=`find /opt/openmpi -name knem.ko | head -1`
if test -n "$kos"; then
  /bin/cp $kos /lib/modules/`uname -r`/extra/
  /sbin/depmod -a
  /sbin/modprobe knem
  /bin/sleep 1
  /bin/chmod 644 /dev/knem
fi
</file>


</post>

</kickstart>
