<?xml version="1.0" standalone="no"?>

<kickstart>

<description>
MPI libraries for MX modules files
http://www.mcs.anl.gov/research/projects/mpi/mpich1
http://www.mcs.anl.gov/research/projects/mpich2
http://www.open-mpi.org
</description>

<copyright>
Copyright (c) 2000 - 2009 The Regents of the University of California.
All rights reserved. Rocks(r) v5.1 www.rocksclusters.org
</copyright>

<changelog>
</changelog>

<post>

# Make sure modules package reads modulefiles from /opt/modulefiles/mpi
line='setenv MODULEPATH /opt/modulefiles/mpi:$MODULEPATH'
if test `grep -Fc "$line" /etc/profile.d/modules.csh` = 0; then
  echo "$line" >> /etc/profile.d/modules.csh
fi
line='export MODULEPATH=/opt/modulefiles/mpi:$MODULEPATH'
if test `grep -Fc "$line" /etc/profile.d/modules.sh` = 0; then
  echo "$line" >> /etc/profile.d/modules.sh
fi

<!-- env vars in <file> tags don't work, so use fixed-path temps -->
/bin/mkdir -m 0755 -p /opt/modulefiles/.tmp

# MPICH

export version=1.2.7
/bin/mkdir -m 0755 -p /opt/modulefiles/mpi/mpich_mx

<file name="/opt/modulefiles/.tmp/mpich_mx" perms="0644">
#%Module1.0
set mpich_mxHome /opt/mpich_mx
set compiler [expr ! [catch {exec which icc} ignored] ? {"intel"} : \
                   ! [catch {exec which pgcc} ignored] ? {"pgi"} : {"gnu"}]
set suffix [expr {$compiler} == {"gnu"} ? {""} : {"/$compiler"}]
if { ! [file exists $mpich_mxHome/bin$suffix] } {
  puts stderr "No $compiler mpich_mx implementation is available"
  break
}
module-whatis "mpich_mx mpi stack"
module-whatis "Version: VERSION"
prepend-path PATH $mpich_mxHome/bin$suffix
prepend-path LD_LIBRARY_PATH $mpich_mxHome/lib$suffix
</file>
/usr/bin/perl -pi -e "s/VERSION/$version/" /opt/modulefiles/.tmp/mpich_mx
/bin/cp /opt/modulefiles/.tmp/mpich_mx /opt/modulefiles/mpi/mpich_mx/$version

<file name="/opt/modulefiles/.tmp/mpich_mx.version" perms="0644">
#%Module1.0
set ModulesVersion "VERSION"
</file>
/usr/bin/perl -pi -e "s/VERSION/$version/" \
              /opt/modulefiles/.tmp/mpich_mx.version
/bin/cp /opt/modulefiles/.tmp/mpich_mx.version \
        /opt/modulefiles/mpi/mpich_mx/.version.$version

/bin/ln -s /opt/modulefiles/mpi/mpich_mx/.version.$version \
           /opt/modulefiles/mpi/mpich_mx/.version

# MPICH2

export version=1.0.7
/bin/mkdir -m 0755 -p /opt/modulefiles/mpi/mpich2_mx

<file name="/opt/modulefiles/.tmp/mpich2_mx" perms="0644">
#%Module1.0
set mpich2_mxHome /opt/mpich2_mx
set compiler [expr ! [catch {exec which icc} ignored] ? {"intel"} : \
                   ! [catch {exec which pgcc} ignored] ? {"pgi"} : {"gnu"}]
set suffix [expr {$compiler} == {"gnu"} ? {""} : {"/$compiler"}]
if { ! [file exists $mpich2_mxHome/bin$suffix] } {
  puts stderr "No $compiler mpich2_mx implementation is available"
  break
}
module-whatis "mpich2_mx mpi stack"
module-whatis "Version: VERSION"
prepend-path PATH $mpich2_mxHome/bin$suffix
prepend-path LD_LIBRARY_PATH $mpich2_mxHome/lib$suffix
</file>
/usr/bin/perl -pi -e "s/VERSION/$version/" /opt/modulefiles/.tmp/mpich2_mx
/bin/cp /opt/modulefiles/.tmp/mpich2_mx \
        /opt/modulefiles/mpi/mpich2_mx/$version

<file name="/opt/modulefiles/.tmp/mpich2_mx.version" perms="0644">
#%Module1.0
set ModulesVersion "VERSION"
</file>
/usr/bin/perl -pi -e "s/VERSION/$version/" \
              /opt/modulefiles/mpi/mpich2_mx.version
/bin/cp /opt/modulefiles/.tmp/mpich2_mx.version \
        /opt/modulefiles/mpi/mpich2_mx/.version.$version

/bin/ln -s /opt/modulefiles/mpi/mpich2_mx/.version.$version \
           /opt/modulefiles/mpi/mpich2_mx/.version

# OPENMPI

export version=1.3.3
/bin/mkdir -m 0755 -p /opt/modulefiles/mpi/openmpi_mx

<file name="/opt/modulefiles/.tmp/openmpi_mx" perms="0644">
#%Module1.0
set openmpi_mxHome /opt/openmpi_mx
set compiler [expr ! [catch {exec which icc} ignored] ? {"intel"} : \
                   ! [catch {exec which pgcc} ignored] ? {"pgi"} : {"gnu"}]
set suffix [expr {$compiler} == {"gnu"} ? {""} : {"/$compiler"}]
if { ! [file exists $openmpi_mxHome/bin$suffix] } {
  puts stderr "No $compiler openmpi_mx implementation is available"
  break
}
module-whatis "openmpi_mx mpi stack"
module-whatis "Version: VERSION"
prepend-path PATH $openmpi_mxHome/bin$suffix
prepend-path LD_LIBRARY_PATH $openmpi_mxHome/lib$suffix
</file>
/usr/bin/perl -pi -e "s/VERSION/$version/" /opt/modulefiles/.tmp/openmpi_mx
/bin/cp /opt/modulefiles/.tmp/openmpi_mx \
        /opt/modulefiles/mpi/openmpi_mx/$version

<file name="/opt/modulefiles/.tmp/openmpi_mx.version" perms="0644">
#%Module1.0
set ModulesVersion "VERSION"
</file>
/usr/bin/perl -pi -e "s/VERSION/$version/" \
              /opt/modulefiles/.tmp/openmpi_mx.version
/bin/cp /opt/modulefiles/.tmp/openmpi_mx.version \
        /opt/modulefiles/mpi/openmpi_mx/.version.$version

/bin/ln -s /opt/modulefiles/mpi/openmpi_mx/.version.$version \
           /opt/modulefiles/mpi/openmpi_mx/.version

</post>

</kickstart>
